<!-- css -->
<%- css(theme.asset.fancybox_css) %>
<%- js(theme.asset.marked_js) %>
<section class="px-6 max-w-prose mx-auto md:px-0">
    <!-- header -->
    <header class="overflow-hidden pt-6 pb-6 md:pt-12">
        <div class="pt-4 md:pt-6">
            <h1 id="article-title" class="heti--serif text-[2rem] font-bold leading-snug mb-4 md:mb-6 md:text-[2.6rem]">
                <%- page.title %>
            </h1>
        </div>
    </header>
    <!-- content -->
    <article id="memos" class="bg-white dark:bg-zinc-800 post-content">
        <section class="flex p-5 memo">
            <img class="w-14 h-14 p-2 rounded object-cover no_fancy" src="<%= theme.avatar %>" alt="<%= config.author %>">
            <div class="p-2 grid grid-cols-1 text-sm">
                <p class="font-bold pb-4 text-base" style="color: var(--roy-main)"><%= config.author %></p>
                <p class="p-5" id="memos-content">
                    <i class="ri-loader-4-line animate-spin inline-block"></i>
                    正在加载中...
                </p>
                <p class="time text-xs text-gray-400 pt-2">14:25</p>
            </div>
        </section>
    </article>
</section>

<style>
  .memo + .memo {
    border-top: 0.5px dashed #cccccc99;
  }
</style>

<script>
  function fetchMemos() {
    document.getElementById('memos-content').innerHTML = '<i class="ri-loader-4-line animate-spin inline-block"></i>正在加载中...'
    fetch("<%= theme.memos.url %>/api/memo/all?limit=<%= theme.memos.limit %>").then(resp => {
      if (resp && resp.ok) {
        resp.json().then(res => {
          const { data } = res;
          if (data && data.length) {
            document.getElementById('memos').innerHTML = data.map(item => {
              return `
                <section class="flex p-5 memo">
                    <img class="no_fancy object-cover w-14 h-14 p-2 rounded" src="<%= theme.avatar %>" alt="${item.creatorName}">
                    <div class="p-2 grid grid-cols-1 text-sm">
                        <p class="font-bold pb-4 text-base" style="color: var(--roy-main)">${item.creatorName}</p>
                        <div class="heti">${marked.parse(item.content)}</div>
                        <div class="${(item.resourceList && item.resourceList.length > 1) ? 'grid-cols-3 w-[45%]' : 'grid-cols-1 w-[85%]'} pt-2 grid gap-2">
                            ${
                                item.resourceList && item.resourceList.filter(resource => {
                                  return resource.type.startsWith('image')
                                }).map(resource => {
                                  return `
                                                <img class="rounded object-cover" style="aspect-ratio: 1" src="<%= theme.memos.url %>/o/r/${resource.id}/${resource.publicId}" alt="${item.creatorName}" />
                                            `
                                  }).join('')
                                }
                        </div>
                        <p class="time text-xs text-gray-400 pt-2">${new Date(parseInt(item.createdTs) * 1000).toLocaleString().replace(/:\d{1,2}$/,' ')}</p>
                    </div>
                </section>
            `
            }).join('')
            doFancyBox()
          }
        }).catch(err => {
          document.getElementById('memos-content').innerHTML = `<p>加载失败！</p><pre>${err.message}</pre><p><a onclick="fetchMemos()">点击重试</a></p>`
        })
      } else {
        document.getElementById('memos-content').innerHTML = `<p>加载失败！</p><p><a onclick="fetchMemos()">点击重试</a></p>`
      }
    }).catch(err => {
      document.getElementById('memos-content').innerHTML = `<p>加载失败！</p><pre>${err.message}</pre><p><a onclick="fetchMemos()">点击重试</a></p>`
    })
  }
  fetchMemos()
</script>

<!-- js inspect -->
<%- partial('_plugins/fancybox') %>
